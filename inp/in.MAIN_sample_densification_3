# LAMMPS INPUT FILE PERFORMING THE DENSIFICATION OF THE LOOSE SAMPLE PREVIOUSLY PREPARED UNDER ISOTROPIC COMPRESSION OF 3D GRANULAR SYSTEMS
# file: in.MAIN_sample_densification_3
# author: JBC @ NORTHWESTERN UNIVERSITY, 04/14/2020
#
# THIS IS A MAIN SCRIPT. ALL VARIABLES AND COMPUTES IN THIS SUBSCRIPT ARE GLOBAL AND GIVEN DEFAULT VALUES THAT CAN BE OVERWRITTEN LOCALLY IN THE MAIN SCRIPT
# THIS SCRIPT MUST ONLY BE CALLED ONE TIME
#
#
# INFO :
# - THERE ARE CURRENTLY ISSUES WITH TRICLINIC CELLS AND POLYDISPERSE GRANULAR MODELS. WE MUST USE ORTHOGONAL BOX
# - Uses method from Salot et al., 2009 with reduced friction. Add a slight vibration to create dense systems of low coordination (Agnolin & Roux 2007)
#
# TODO:
# -
# -

####################
# ---- HEADER ---- #
####################

# ---- LOAD INITIAL SAMPLE ---- #

read_restart restart.sample_3

# ---- DEFINITION OF THE PARAMETERS AND LAMMPS REQUIREMENTS ---- #

include in.DEF_init_particles_3
include in.DEF_init_material_3
include in.DEF_param_sample_3
include in.DEF_param_simulation_3
include in.DEF_param_BC_control_3
include in.DEF_param_equilibrium_3
include in.DEF_init_post_3

# ---- SETUP OF THE BOUNDARY CONDITIONS AND STRUCTURES ---- #

variable BC_XX_WALL equal false # Overwrite default, creates PBC/WALL
variable BC_YY_WALL equal false # Overwrite default, creates PBC/WALL
variable BC_ZZ_WALL equal false # Overwrite default, creates PBC/WALL

variable READWALL equal true # determine wall coordinates (if wall) from file. DO NOT CHANGE

include in.SET_structure_3
include in.SET_boundary_3
include in.SET_macro_properties_3

# ---- TIME INTEGRATION ---- #
if "${SPHERE}" then "fix time_integration_particles particles nve/sphere" &
elif "!${SPHERE}" "fix time_integration_clumps particles rigid/small molecule" "fix_modify time_integration_clumps bodyforces early # forces must be calculated early for per-clump damping to work" &
else "print 'Script Error: flag SPHERE should have value true or false and was given $(v_SPHERE)'" "quit"

include in.SET_conv_3

# ---- MATERIAL AND CONTACT LAW ---- #

variable friction_reduction equal 0.65 # Reduction coefficient between 0 and 1
pair_style	granular
pair_coeff * * hertz/material $E ${ncdc} ${nu} tangential mindlin_rescale NULL ${tcdr} $(v_f*v_friction_reduction) # Contact law with reduced friction for densification (Salot et al., 2009)


#####################################
# DENSIFICATION BY REDUCED FRICTION #
#####################################


if "${SPHERE}" then &
"fix damp_particles_Yade particles cundamp ${damp0particles} ${damp0particles} # Yade Translational and Rotational damping of particles" &
elif "!${SPHERE}" &
"fix damp_particles_Yade particles cundamp/rigid time_integration_clumps ${damp0particles} ${damp0particles} # Yade Translational and Rotational damping of particles" &
else "print 'Script Error: flag SPHERE should have value true or false and was given $(v_SPHERE)'" "quit"

## FIRST COMPRESSION WITH REMAPPING TO ENSURE HOMEGENEITY OF STRESS/SAMPLE

variable In0 equal 1e-3 # Overwrite the inertial number to smaller values for compression
variable REMAP equal true

variable SHEARRELAX equal false # No shear/tilt relax - orthogonal box
include in.PRESET_BC_control_ISO_3 # preset isotropic conditions to target pressure
include in.START_BC_control_3 # Start Boundary controller

include in.PRESET_equilibrium_stress_3 # Sets equilibrium conditions on stress only
include in.START_equilibrium_3 # Start equilibrium check

variable zmean equal c_zsum/v_Nparticles
thermo_style custom step v_convke v_convufr v_convfres v_convtqres v_pxx v_pyy v_pzz v_pxy v_pxz v_pyz v_lx v_ly v_lz xy xz yz v_pf v_zmean
thermo ${Nthermo}
run ${Nmax} # Will be stopped at equilibrium

include in.STOP_BC_control_3 # Stop Boundary controller

## EXPANSION TO RELEASE CONTACTS

thermo_style custom step v_pxx v_pyy v_pzz v_pxy v_pxz v_pyz v_lx v_ly v_lz xy xz yz v_pf
run 0 # To allow change box (verify at the run that all pressure are equal to zero i.e. no contact between particles)
variable expansion equal 0.001 # We stop when average indentation (Kappa^-1 = h/d) is smaller than 0.001 [Agnolin 2007] uses 0.005 to remap, we do the same but use a smaller criterion for convergence before making a bigger remap using 0.005
change_box all x scale $(1+v_expansion) y scale $(1+v_expansion) z scale $(1+v_expansion) remap # Expansion to make sure there is no contact left

## SMALL VIBRATION TO SLIGHTLY SHIFT CONTACTS AND BREAK DENSITY - COORDINATION CORRELATION
pair_coeff * * hertz/material $E ${ncdc} ${nu} tangential mindlin_rescale NULL ${tcdr} 0.0 # Contact law with no friction for shaking phase (Agnolin & Roux 2007)
velocity particles create $(1e0*v_msys*((v_dsys/v_K0)/v_tsyshertz)^2/(3*1.380e-23)) ${mixseed} temp temp_sphere # CHANGE THE PREFACTOR TO SHAKE WITH MORE INTENSITY
run 0
velocity particles scale $(1e0*v_msys*((v_dsys/1e4)/v_tsyshertz)^2/(3*1.380e-23)) temp temp_sphere

thermo_style custom step v_pxx v_pyy v_pzz v_pxy v_pxz v_pyz v_lx v_ly v_lz xy xz yz v_pf
run 1000 # Shake for a very short period, just to shift contact topology

velocity particles set 0.0 0.0 0.0
set group particles omega 0.0 0.0 0.0

# RE SEPARATE BEFORE FINAL COMPACTION
change_box all x scale $(1+v_expansion) y scale $(1+v_expansion) z scale $(1+v_expansion) remap # Expansion to make sure there is no contact left
# RE SEPARATE BEFORE FINAL COMPACTION

pair_coeff * * hertz/material $E ${ncdc} ${nu} tangential mindlin_rescale NULL ${tcdr} $f # Contact law with true friction for finale assembly at the given porosity (Agnolin & Roux 2007)

## SECOND COMPRESSION WITH/WITHOUT REMAPPING DEPENDING ON WALLS / NO WALLS

if "${BC_XX_WALL} && ${BC_YY_WALL} && ${BC_ZZ_WALL}" then &
"variable REMAP equal false # Final equilibration without remapping if walls" &
elif "!${BC_XX_WALL} && !${BC_YY_WALL} && !${BC_ZZ_WALL}" &
"variable REMAP equal true # Final equilibration with remapping if PBC" &
else &
"print 'Script Error: boundaries must either all be periodic or all have walls. Flags BC_AXIS_WALL were given $(v_BC_XX_WALL), $(v_BC_YY_WALL) and $(v_BC_ZZ_WALL)'" &
"quit"

include in.PRESET_equilibrium_all_3 # Sets equilibrium conditions on all variables
include in.START_BC_control_3

if "${SPHERE}" then &
"fix damp_particles_visct floaters viscous $(v_visc0particles*2*sqrt(v_msys*v_hertzstiff)) # Translational Global damping of particles" &
"fix damp_particles_viscr floaters viscous/sphere $(v_visc0particles*0.5*v_dsys^2*sqrt(2*v_msys*v_hertzstiff_rot/5)) # Rotational Global damping of particles" &
elif "!${SPHERE}" &
"fix damp_particles_visct floaters viscous/rigid time_integration_clumps $(v_visc0particles*2*sqrt(v_msys*v_hertzstiff)) $(v_visc0particles*0.5*v_dsys^2*sqrt(2*v_msys*v_hertzstiff_rot/5)) # Global damping of rigid particles" &
else "print 'Script Error: flag SPHERE should have value true or false and was given $(v_SPHERE)'" "quit"

thermo_style custom step v_convke v_convufr v_convfres v_convtqres v_pxx v_pyy v_pzz v_pxy v_pxz v_pyz v_lx v_ly v_lz xy xz yz v_pf v_zmean
thermo ${Nthermo}
run ${Nmax} # Will be stopped at equilibrium

include in.STOP_BC_control_3 # Stop Boundary controller
include in.STOP_equilibrium_3 # Stop equilibrium check

set group floaters omega 0.0 0.0 0.0 # Kill completely velocity of floaters
velocity floaters set 0.0 0.0 0.0 # Kill completely velocity of floaters

###########################################
# ---- OUTPUT / SAVE SYSTEM GEOMETRY ---- #
###########################################

# Walls coordinates

if '${BC_XX_WALL} && ${BC_YY_WALL} && ${BC_ZZ_WALL}' then &
'print """# Position of the walls after initial deposition
$(v_xlo_BC) # xlo wall
$(v_xhi_BC) # xhi wall
$(v_ylo_BC) # ylo wall
$(v_yhi_BC) # yhi wall
$(v_zlo_BC) # zlo wall
$(v_zhi_BC) # zhi wall """ file wpos0_dense_Salot2009_$(v_friction_reduction).txt'

# Particles coordinates and topology

dump savedmpcoor particles custom 1 dump.co_sample_densification_$(v_friction_reduction)_3.lammpstrj id x y z diameter
dump_modify savedmpcoor sort id

compute savepair particles property/local patom1 patom2 cutoff radius # pairs of particles within force cutoff
compute savecontact particles pair/local force p4 p10 p11 p12 cutoff radius # interparticle distance, normal force magnitude, tangent force magnitude, branch vector x, y, z
dump savedmptopo particles local 1 dump.topo_sample_densification_$(v_friction_reduction)_3.lammpstrj c_savepair[*] c_savecontact[*]

run 0 # To output final coordinates and neighbor list

# Restart / data file

write_restart restart.sample_densification_$(v_friction_reduction)_3
write_data data.sample_densification_$(v_friction_reduction)_3
